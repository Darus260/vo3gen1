 // --- API KEY (OBFUSCATED) ---
        const obfuscatedApiKey = 'QUl6YVN5QXpGclVkaVUwNEMwYlJVZ1MxMWhjLWVWMkIxWEtidk5N';
        
        // --- IKLAN: DAFTAR LINK IKLAN ANDA ---
        const adLinks = [
            'https://s.shopee.co.id/4fkJj4u69U',
            'https://s.shopee.co.id/4q3jvNtSoX',
            'https://s.shopee.co.id/50NA7gspTa',
            'https://s.shopee.co.id/5AgaJzsC8d',
            'https://s.shopee.co.id/2fzFLP1iDA',
            'https://s.shopee.co.id/2qIfXi14sD',
            'https://s.shopee.co.id/30c5k10RXG',
            'https://s.shopee.co.id/3AvVwJzoCJ',
            'https://s.shopee.co.id/3LEw8czArM',
            'https://s.shopee.co.id/3VYMKvyXWP',
            'https://s.shopee.co.id/3frmXExuBS',
            'https://s.shopee.co.id/3qBCjXxGqV',
            'https://s.shopee.co.id/1LTrkx6mv2',
            'https://s.shopee.co.id/1VnHxG69a5',
            'https://s.shopee.co.id/1g6i9Z5WF8',
            'https://s.shopee.co.id/1qQ8Ls4suB',
            'https://s.shopee.co.id/20jYYB4FZE',
            'https://s.shopee.co.id/2B2ykU3cEH',
            'https://s.shopee.co.id/2LMOwn2ytK',
            'https://s.shopee.co.id/2Vfp962LYN',
            'https://s.shopee.co.id/yUAVBrcu',
            'https://s.shopee.co.id/BHuMoBEHx',
            'https://s.shopee.co.id/LbKZ7Aax0',
            'https://s.shopee.co.id/VuklQ9xc3',
            'https://s.shopee.co.id/gEAxj9KH6',
            'https://s.shopee.co.id/qXbA28gw9',
            'https://s.shopee.co.id/10r1ML83bC',
            'https://s.shopee.co.id/1BARYe7QGF',
            'https://s.shopee.co.id/9KW9HecKgq',
            'https://s.shopee.co.id/9UpZTxbhLt',
            'https://s.shopee.co.id/9f8zgGb40w',
            'https://s.shopee.co.id/9pSPsZaQfz',
            'https://s.shopee.co.id/9zlq4sZnL2',
            'https://s.shopee.co.id/AA5GHBZA05',
            'https://s.shopee.co.id/AKOgTUYWf8',
            'https://s.shopee.co.id/AUi6fnXtKB',
            'https://s.shopee.co.id/800lhChPOi',
            'https://s.shopee.co.id/8AKBtVgm3l',
            'https://s.shopee.co.id/8Kdc5og8io',
            'https://s.shopee.co.id/8Ux2I7fVNr',
            'https://s.shopee.co.id/8fGSUQes2u',
            'https://s.shopee.co.id/8pZsgjeEhx',
            'https://s.shopee.co.id/8ztIt2dbN0',
            'https://s.shopee.co.id/9ACj5Lcy23',
            'https://s.shopee.co.id/6fVO6kmU6a',
            'https://s.shopee.co.id/6pooJ3lqld',
            'https://s.shopee.co.id/708EVMlDQg',
            'https://s.shopee.co.id/7ARehfka5j',
            'https://s.shopee.co.id/7Kl4tyjwkm',
            'https://s.shopee.co.id/7V4V6HjJPp',
            'https://s.shopee.co.id/7fNvIaig4s',
            'https://s.shopee.co.id/7phLUti2jv',
            'https://s.shopee.co.id/5L00WIrYoS',
            'https://s.shopee.co.id/5VJQibqvTV',
            'https://s.shopee.co.id/5fcquuqI8Y',
            'https://s.shopee.co.id/5pwH7Dpenb',
            'https://s.shopee.co.id/60FhJWp1Se',
            'https://s.shopee.co.id/6AZ7VpoO7h',
            'https://s.shopee.co.id/6KsXi8nkmk',
            'https://s.shopee.co.id/6VBxuRn7Rn',
            'https://s.shopee.co.id/4Ao389w0BM',
            'https://s.shopee.co.id/40UcvqwdWL',
            'https://s.shopee.co.id/4VQtWlujVS',
            'https://s.shopee.co.id/4L7TKSvMqR',
            'https://s.shopee.co.id/4q3jvNtSpY',
            'https://s.shopee.co.id/4fkJj4u6AX',
            'https://s.shopee.co.id/5AgaJzsC9e',
            'https://s.shopee.co.id/50NA7gspUd',
            'https://s.shopee.co.id/2qIfXi14tE',
            'https://s.shopee.co.id/2fzFLP1iED',
            'https://s.shopee.co.id/3AvVwJzoDK',
            'https://s.shopee.co.id/30c5k10RYJ',
            'https://s.shopee.co.id/3VYMKvyXXQ',
            'https://s.shopee.co.id/3LEw8czAsP',
            'https://s.shopee.co.id/3qBCjXxGrW',
            'https://s.shopee.co.id/3frmXExuCV',
            'https://s.shopee.co.id/1VnHxG69b6',
            'https://s.shopee.co.id/1LTrkx6mw5',
            'https://s.shopee.co.id/1qQ8Ls4svC',
            'https://s.shopee.co.id/1g6i9Z5WGB',
            'https://s.shopee.co.id/2B2ykU3cFI',
            'https://s.shopee.co.id/20jYYB4FaH',
            'https://s.shopee.co.id/2Vfp962LZO',
            'https://s.shopee.co.id/2LMOwn2yuN',
            'https://s.shopee.co.id/BHuMoBEIy',
            'https://s.shopee.co.id/yUAVBrdx',
            'https://s.shopee.co.id/VuklQ9xd4',
            'https://s.shopee.co.id/LbKZ7Aay3',
            'https://s.shopee.co.id/qXbA28gxA',
            'https://s.shopee.co.id/gEAxj9KI9',
            'https://s.shopee.co.id/1BARYe7QHG',
            'https://s.shopee.co.id/10r1ML83cF',
            'https://s.shopee.co.id/9UpZTxbhMu',
            'https://s.shopee.co.id/9KW9HecKht',
            'https://s.shopee.co.id/9pSPsZaQh0',
            'https://s.shopee.co.id/9f8zgGb41z',
            'https://s.shopee.co.id/AA5GHBZA16',
            'https://s.shopee.co.id/9zlq4sZnM5',
            'https://s.shopee.co.id/AUi6fnXtLC',
            'https://s.shopee.co.id/AKOgTUYWgB',
            'https://s.shopee.co.id/9f8zp4J261',
            'https://s.shopee.co.id/9UpZclJfR0',
            'https://s.shopee.co.id/9KW9QSKIlz',
            'https://s.shopee.co.id/9ACjE9Kw6y',
            'https://s.shopee.co.id/8ztJ1qLZRx',
            'https://s.shopee.co.id/8pZspXMCmw',
            'https://s.shopee.co.id/8fGSdEMq7v',
            'https://s.shopee.co.id/8Ux2QvNTSu',
            'https://s.shopee.co.id/8KdcEcO6nt',
            'https://s.shopee.co.id/8AKC2JOk8s',
            'https://s.shopee.co.id/800lq0PNTr',
            'https://s.shopee.co.id/7phLdhQ0oq',
            'https://s.shopee.co.id/7fNvROQe9p',
            'https://s.shopee.co.id/7V4VF5RHUo',
            'https://s.shopee.co.id/7Kl52mRupn',
            'https://s.shopee.co.id/7AReqTSYAm',
            'https://s.shopee.co.id/708EeATBVl',
            'https://s.shopee.co.id/6pooRrToqk',
            'https://s.shopee.co.id/6fVOFYUSBj',
            'https://s.shopee.co.id/6VBy3FV5Wi',
            'https://s.shopee.co.id/6KsXqwVirh',
            'https://s.shopee.co.id/6AZ7edWMCg',
            'https://s.shopee.co.id/60FhSKWzXf',
            'https://s.shopee.co.id/5pwHG1Xcse',
            'https://s.shopee.co.id/5fcr3iYGDd',
            'https://s.shopee.co.id/5VJQrPYtYc',
            'https://s.shopee.co.id/5L00f6ZWtb',
            'https://s.shopee.co.id/5AgaSnaAEa',
            'https://s.shopee.co.id/50NAGUanZZ',
            'https://s.shopee.co.id/4q3k4BbQuY',
            'https://s.shopee.co.id/4fkJrsc4FX',
            'https://s.shopee.co.id/4VQtfZchaW',
            'https://s.shopee.co.id/4L7TTGdKvV',
            'https://s.shopee.co.id/4Ao3GxdyGU',
            'https://s.shopee.co.id/40Ud4eebbT',
            'https://s.shopee.co.id/3qBCsLfEwS',
            'https://s.shopee.co.id/3frmg2fsHR',
            'https://s.shopee.co.id/3VYMTjgVcQ',
            'https://s.shopee.co.id/3LEwHQh8xP',
            'https://s.shopee.co.id/3AvW57hmIO',
            'https://s.shopee.co.id/30c5soiPdN',
            'https://s.shopee.co.id/2qIfgVj2yM',
            'https://s.shopee.co.id/2fzFUCjgJL',
            'https://s.shopee.co.id/2VfpHtkJeK',
            'https://s.shopee.co.id/2LMP5akwzJ',
            'https://s.shopee.co.id/2B2ytHlaKI',
            'https://s.shopee.co.id/20jYgymDfH',
            'https://s.shopee.co.id/1qQ8Ufmr0G',
            'https://s.shopee.co.id/1g6iIMnULF',
            'https://s.shopee.co.id/1VnI63o7gE',
            'https://s.shopee.co.id/1LTrtkol1D',
            'https://s.shopee.co.id/1BARhRpOMC',
            'https://s.shopee.co.id/10r1V8q1hB',
            'https://s.shopee.co.id/qXbIpqf2A',
            'https://s.shopee.co.id/gEB6WrIN9',
            'https://s.shopee.co.id/VukuDrvi8',
            'https://s.shopee.co.id/LbKhusZ37',
            'https://s.shopee.co.id/BHuVbtCO6',
            'https://s.shopee.co.id/yUJItpj5',
            'https://s.shopee.co.id/AKOgcIGUl6',
            'https://s.shopee.co.id/AUi6obFrQ9',
            'https://s.shopee.co.id/9zlqDgHlR4',
            'https://s.shopee.co.id/AA5GPzH867',
            'https://s.shopee.co.id/9f8zp4J272',
            'https://s.shopee.co.id/9pSQ1NIOm5',
            'https://s.shopee.co.id/9KW9QSKIn0',
            'https://s.shopee.co.id/9UpZclJfS3',
            'https://s.shopee.co.id/8ztJ1qLZSy',
            'https://s.shopee.co.id/9ACjE9Kw81',
            'https://s.shopee.co.id/8fGSdEMq8w',
            'https://s.shopee.co.id/8pZspXMCnz',
            'https://s.shopee.co.id/8KdcEcO6ou',
            'https://s.shopee.co.id/8Ux2QvNTTx',
            'https://s.shopee.co.id/800lq0PNUs',
            'https://s.shopee.co.id/8AKC2JOk9v',
            'https://s.shopee.co.id/7fNvROQeAq',
            'https://s.shopee.co.id/7phLdhQ0pt',
            'https://s.shopee.co.id/7Kl52mRuqo',
            'https://s.shopee.co.id/7V4VF5RHVr',
            'https://s.shopee.co.id/708EeATBWm',
            'https://s.shopee.co.id/7AReqTSYBp',
            'https://s.shopee.co.id/6fVOFYUSCk',
            'https://s.shopee.co.id/6pooRrTorn',
            'https://s.shopee.co.id/6KsXqwVisi',
            'https://s.shopee.co.id/6VBy3FV5Xl',
            'https://s.shopee.co.id/60FhSKWzYg',
            'https://s.shopee.co.id/6AZ7edWMDj',
            'https://s.shopee.co.id/5fcr3iYGEe',
            'https://s.shopee.co.id/5pwHG1Xcth',
            'https://s.shopee.co.id/5L00f6ZWuc',
            'https://s.shopee.co.id/5VJQrPYtZf',
            'https://s.shopee.co.id/50NAGUanaa',
            'https://s.shopee.co.id/5AgaSnaAFd',
            'https://s.shopee.co.id/4fkJrsc4GY',
            'https://s.shopee.co.id/4q3k4BbQvb',
            'https://s.shopee.co.id/4L7TTGdKwW',
            'https://s.shopee.co.id/4VQtfZchbZ',
            'https://s.shopee.co.id/40Ud4eebcU',
            'https://s.shopee.co.id/4Ao3GxdyHX',
            'https://s.shopee.co.id/3frmg2fsIS',
            'https://s.shopee.co.id/4fkJxolON6',
            'https://s.shopee.co.id/4q3kA7kl29',
            'https://s.shopee.co.id/50NAMQk7hC',
            'https://s.shopee.co.id/5AgaYjjUMF',
            'https://s.shopee.co.id/40UdAanvj2',
            'https://s.shopee.co.id/4Ao3MtnIO5',
            'https://s.shopee.co.id/4L7TZCmf38',
            'https://s.shopee.co.id/4VQtlVm1iB',
            'https://s.shopee.co.id/3LEwNMqT4y',
            'https://s.shopee.co.id/3VYMZfppk1',
            'https://s.shopee.co.id/3frmlypCP4',
            'https://s.shopee.co.id/3qBCyHoZ47',
            'https://s.shopee.co.id/2fzFa8t0Qu',
            'https://s.shopee.co.id/2qIfmRsN5x',
            'https://s.shopee.co.id/30c5ykrjl0',
            'https://s.shopee.co.id/3AvWB3r6Q3',
            'https://s.shopee.co.id/20jYmuvXmq',
            'https://s.shopee.co.id/2B2yzDuuRt',
            'https://s.shopee.co.id/2LMPBWuH6w',
            'https://s.shopee.co.id/2VfpNptdlz',
            'https://s.shopee.co.id/1LTrzgy58m',
            'https://s.shopee.co.id/1VnIBzxRnp',
            'https://s.shopee.co.id/1g6iOIwoSs',
            'https://s.shopee.co.id/1qQ8abwB7v',
            'https://s.shopee.co.id/gEBCT0cUi',
            'https://s.shopee.co.id/qXbOlzz9l',
            'https://s.shopee.co.id/10r1b4zLoo',
            'https://s.shopee.co.id/1BARnNyiTr',
            'https://s.shopee.co.id/yUPF39qe',
            'https://s.shopee.co.id/BHubY2WVh',
            'https://s.shopee.co.id/LbKnr1tAk',
            'https://s.shopee.co.id/Vul0A1Fpn',
            'https://s.shopee.co.id/9zlqJcR5Ye',
            'https://s.shopee.co.id/AA5GVvQSDh',
            'https://s.shopee.co.id/AKOgiEPosk',
            'https://s.shopee.co.id/AUi6uXPBXn',
            'https://s.shopee.co.id/9KW9WOTcua',
            'https://s.shopee.co.id/9UpZihSzZd',
            'https://s.shopee.co.id/9f8zv0SMEg',
            'https://s.shopee.co.id/9pSQ7JRitj',
            'https://s.shopee.co.id/8fGSjAWAGW',
            'https://s.shopee.co.id/8pZsvTVWvZ',
            'https://s.shopee.co.id/8ztJ7mUtac',
            'https://s.shopee.co.id/9ACjK5UGFf',
            'https://s.shopee.co.id/800lvwYhcS',
            'https://s.shopee.co.id/8AKC8FY4HV',
            'https://s.shopee.co.id/8KdcKYXQwY',
            'https://s.shopee.co.id/8Ux2WrWnbb',
            'https://s.shopee.co.id/7Kl58ibEyO',
            'https://s.shopee.co.id/7V4VL1abdR',
            'https://s.shopee.co.id/7fNvXKZyIU',
            'https://s.shopee.co.id/7phLjdZKxX',
            'https://s.shopee.co.id/6fVOLUdmKK',
            'https://s.shopee.co.id/6pooXnd8zN',
            'https://s.shopee.co.id/708Ek6cVeQ',
            'https://s.shopee.co.id/7ARewPbsJT',
            'https://s.shopee.co.id/60FhYGgJgG',
            'https://s.shopee.co.id/6AZ7kZfgLJ',
            'https://s.shopee.co.id/6KsXwsf30M',
            'https://s.shopee.co.id/6VBy9BePfP',
            'https://s.shopee.co.id/5L00l2ir2C',
            'https://s.shopee.co.id/5VJQxLiDhF',
            'https://s.shopee.co.id/5fcr9ehaMI',
            'https://s.shopee.co.id/5pwHLxgx1L',
            'https://s.shopee.co.id/4q3kA7kl3A',
            'https://s.shopee.co.id/4fkJxolOO9',
            'https://s.shopee.co.id/5AgaYjjUNG',
            'https://s.shopee.co.id/50NAMQk7iF',
            'https://s.shopee.co.id/4Ao3MtnIP6',
            'https://s.shopee.co.id/40UdAanvk5',
            'https://s.shopee.co.id/4VQtlVm1jC',
            'https://s.shopee.co.id/4L7TZCmf4B',
            'https://s.shopee.co.id/3VYMZfppl2',
            'https://s.shopee.co.id/3LEwNMqT61',
            'https://s.shopee.co.id/3qBCyHoZ58',
            'https://s.shopee.co.id/3frmlypCQ7',
            'https://s.shopee.co.id/2qIfmRsN6y',
            'https://s.shopee.co.id/2fzFa8t0Rx',
            'https://s.shopee.co.id/3AvWB3r6R4',
            'https://s.shopee.co.id/30c5ykrjm3',
            'https://s.shopee.co.id/2B2yzDuuSu',
            'https://s.shopee.co.id/20jYmuvXnt',
            'https://s.shopee.co.id/2VfpNptdn0',
            'https://s.shopee.co.id/2LMPBWuH7z',
            'https://s.shopee.co.id/1VnIBzxRoq',
            'https://s.shopee.co.id/1LTrzgy59p',
            'https://s.shopee.co.id/1qQ8abwB8w',
            'https://s.shopee.co.id/1g6iOIwoTv',
            'https://s.shopee.co.id/qXbOlzzAm',
            'https://s.shopee.co.id/gEBCT0cVl',
            'https://s.shopee.co.id/1BARnNyiUs',
            'https://s.shopee.co.id/10r1b4zLpr',
            'https://s.shopee.co.id/BHubY2WWi',
            'https://s.shopee.co.id/yUPF39rh',
            'https://s.shopee.co.id/Vul0A1Fqo',
            'https://s.shopee.co.id/LbKnr1tBn',
            'https://s.shopee.co.id/AA5GVvQSEi',
            'https://s.shopee.co.id/9zlqJcR5Zh',
            'https://s.shopee.co.id/AUi6uXPBYo',
            'https://s.shopee.co.id/AKOgiEPotn',
    
        ];
        
        function openRandomAd(links) {
            if (!links || links.length === 0) {
                console.error("Daftar link iklan kosong.");
                return;
            }
            const randomIndex = Math.floor(Math.random() * links.length);
            const randomLink = links[randomIndex];
            window.open(randomLink, '_blank');
        }


        // --- DATA AND STATE ---
        const state = {
            imageBase64: '',
            isAnalyzing: false,
            isLoading: false,
            // Form fields
            subjek: '',
            nama: '',
            usia: '',
            bentukTubuh: 'Normal',
            bentukTubuhManual: '',
            detailWajahRambutHidung: 'Wajah oval, rambut panjang bergelombang, hidung mancung',
            detailWajahRambutHidungManual: '',
            pakaian: 'Kasual (kaos, jeans)',
            pakaianManual: '',
            warnaPakaian: 'Merah',
            warnaPakaianManual: '',
            aksesoris: 'Kacamata',
            aksesorisManual: '',
            rasEtnis: 'Asia',
            rasEtnisManual: '',
            ekspresi: '',
            tempat: '',
            waktu: 'golden-hour',
            weather: 'clear',
            suaraMusik: '',
            scene1Input: '',
            scene2Input: '',
            sceneManual: '',
            kalimatDiucapkan: '',
            detailTambahan: '',
            visualStyle: 'cinematic',
            duration: 10,
            aspectRatio: '16:9',
            frameRate: '24',
            cameraMovement: 'static',
            cameraAngle: 'eye-level',
            lensType: 'standard',
            depthOfField: 'shallow',
            filmGrain: 20,
            chromaticAberration: 10,
            colorGrading: 'neutral',
            dynamicRange: 'standard',
            moodTags: [],
            suasanaVideoManual: '', // used for mood
            videoEngine: 'veo3',
            seed: -1,
            consistency: 75,
            motionIntensity: 50,
            effects: {
                'motion-blur': true, 'lens-flare': false, 'light-leaks': false, 'film-scratches': false, 'vignette': false,
                'vhs-glitch': false, 'datamosh': false, 'scanlines': false, 'pixel-sorting': false,
                'double-exposure': false, 'montage': false, 'time-remapping': false, 'texture-overlay': false,
                'split-screen': false, 'reverse-motion': false, 'time-freeze': false, 'parallax': false,
                'j-cut': false, 'l-cut': false, 'match-cut': false, 'contrast-cut': false,
            }
        };

        document.addEventListener('DOMContentLoaded', () => {

            // --- IKLAN: LOGIC ---
            let initialClickDone = false;
            // 1. Iklan saat klik pertama
            document.body.addEventListener('click', () => {
                if (!initialClickDone) {
                    openRandomAd(adLinks);
                    initialClickDone = true;
                }
            }, { once: true });

            // 2. Iklan setiap 120 detik
            setInterval(() => {
                openRandomAd(adLinks);
            }, 120000); 


            // --- DOM ELEMENTS ---
            const dom = {
                imageAnalysisContainer: document.getElementById('image-analysis-section'),
                manualSectionsContainer: document.getElementById('manual-sections-container'),
                generateFinalPromptBtn: document.getElementById('generate-final-prompt-btn'),
                finalPromptContainer: document.getElementById('final-prompt-container'),
                finalPromptOutput: document.getElementById('final-prompt-output'),
                copyFinalPromptBtn: document.getElementById('copy-final-prompt-btn'),
            };
            
            // --- Helper to create a collapsible section ---
            function createCollapsibleSection(id, title, iconClass, parent, isOpen = false) {
                const sectionContainer = document.createElement('div');
                sectionContainer.innerHTML = `
                    <div class="section-toggle ${isOpen ? 'open' : ''}" id="${id}Toggle">
                        <h3><i class="fas ${iconClass} mr-2"></i> ${title}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content ${isOpen ? '' : 'hidden'}" id="${id}Content"></div>
                `;
                parent.appendChild(sectionContainer);
                
                const toggle = sectionContainer.querySelector(`#${id}Toggle`);
                const content = sectionContainer.querySelector(`#${id}Content`);

                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('open');
                    content.classList.toggle('hidden');
                });
                return content;
            }

            // --- RENDER/UI UPDATE FUNCTIONS ---

            function createTextInput(id, label, container, config = {}) {
                const { placeholder = '', type = 'text', min, max } = config;
                const element = document.createElement('div');
                element.className = 'mb-4';
                element.innerHTML = `<label for="${id}" class="block text-gray-700 text-sm font-bold mb-2">${label}:</label><input type="${type}" id="${id}" min="${min}" max="${max}" placeholder="${placeholder}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500">`;
                const input = element.querySelector('input');
                input.value = state[id];
                input.addEventListener('input', (e) => state[id] = e.target.value);
                container.appendChild(element);
            }
            
            function createTextarea(id, label, container, options = { placeholder: '', rows: 4, className: 'md:col-span-2' }) {
                 const element = document.createElement('div');
                 element.className = `mb-4 ${options.className}`;
                 element.innerHTML = `<label for="${id}" class="block text-gray-700 text-sm font-bold mb-2">${label}:</label><textarea id="${id}" rows="${options.rows}" placeholder="${options.placeholder}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500 h-24 resize-y"></textarea>`;
                 const textarea = element.querySelector('textarea');
                 textarea.value = state[id];
                 textarea.addEventListener('input', (e) => {
                    state[id] = e.target.value;
                 });
                 container.appendChild(element);
            }

            function createSelectInput(id, label, options, container, config = {}) {
                const { hasManual = false, manualId = '', helpText = '', className = ''} = config;
                const element = document.createElement('div');
                element.className = `mb-4 ${className}`;
                let optionsHTML = options.map(opt => `<option value="${opt.value || opt}">${opt.label || opt}</option>`).join('');
                if (hasManual) optionsHTML += '<option value="Isi manual">Isi manual</option>';
                element.innerHTML = `<label for="${id}" class="block text-gray-700 text-sm font-bold mb-2">${label}:</label><select id="${id}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500">${optionsHTML}</select>${hasManual ? `<input type="text" id="${manualId}" class="hidden mt-2 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500" placeholder="Masukkan ${label.toLowerCase()} secara manual">` : ''}${helpText ? `<p class="text-xs text-gray-500 mt-1">${helpText}</p>` : ''}`;
                const select = element.querySelector('select');
                select.value = state[id];
                select.addEventListener('change', (e) => {
                    state[id] = e.target.value;
                    if (hasManual) {
                        const manualInput = document.getElementById(manualId);
                        manualInput.classList.toggle('hidden', e.target.value !== 'Isi manual');
                        if(e.target.value === 'Isi manual') manualInput.focus();
                    }
                });
                if (hasManual) {
                    const manualInput = element.querySelector(`#${manualId}`);
                    if(manualInput) {
                        manualInput.value = state[manualId];
                        manualInput.addEventListener('input', (e) => state[manualId] = e.target.value);
                        if (state[id] === 'Isi manual') manualInput.classList.remove('hidden');
                    }
                }
                container.appendChild(element);
            }

            function createRangeSlider(id, label, container, config = {}) {
                const { min = 0, max = 100, step = 1, unit = '%' } = config;
                const element = document.createElement('div');
                element.className = 'mb-4';
                element.innerHTML = `
                    <label for="${id}" class="block text-gray-700 text-sm font-bold mb-2">${label}</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="${id}" min="${min}" max="${max}" step="${step}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="${id}-value" class="text-sm font-semibold text-gray-700 w-16 text-center">${state[id]}${unit}</span>
                    </div>`;
                const range = element.querySelector(`#${id}`);
                const valueSpan = element.querySelector(`#${id}-value`);
                range.value = state[id];
                range.addEventListener('input', (e) => {
                    state[id] = e.target.value;
                    valueSpan.textContent = `${e.target.value}${unit}`;
                });
                container.appendChild(element);
            }

            function createCheckboxGroup(title, effects, container) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-4';
                let checkboxesHTML = effects.map(effect => `
                    <div class="flex items-center">
                        <input type="checkbox" id="${effect.id}" data-key="${effect.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="${effect.id}" class="ml-2 block text-sm text-gray-900">${effect.label}</label>
                    </div>
                `).join('');

                categoryDiv.innerHTML = `
                    <h4 class="font-semibold text-md mb-2">${title}</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${checkboxesHTML}</div>
                `;
                
                categoryDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    const key = checkbox.dataset.key;
                    checkbox.checked = state.effects[key];
                    checkbox.addEventListener('change', (e) => {
                        state.effects[key] = e.target.checked;
                    });
                });
                container.appendChild(categoryDiv);
            }

            function createTagInput(id, label, container) {
                const element = document.createElement('div');
                element.className = 'mb-4';
                element.innerHTML = `
                    <label class="block text-gray-700 text-sm font-bold mb-2">${label}</label>
                    <div id="${id}-container" class="flex flex-wrap gap-2 mb-2 p-2 border rounded-lg min-h-[40px]"></div>
                    <div class="flex gap-2">
                        <input type="text" id="${id}-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Add tag and press Enter...">
                        <button id="${id}-add-btn" type="button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Add</button>
                    </div>`;
                container.appendChild(element);

                const tagContainer = element.querySelector(`#${id}-container`);
                const tagInput = element.querySelector(`#${id}-input`);
                const addBtn = element.querySelector(`#${id}-add-btn`);

                function renderTags() {
                    tagContainer.innerHTML = '';
                    state.moodTags.forEach((tag, index) => {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'bg-blue-100 text-blue-800 text-sm font-medium me-2 px-2.5 py-0.5 rounded flex items-center gap-1';
                        tagEl.innerHTML = `${tag} <button data-index="${index}" class="text-blue-800 hover:text-blue-900">&times;</button>`;
                        tagEl.querySelector('button').addEventListener('click', (e) => {
                            state.moodTags.splice(index, 1);
                            renderTags();
                        });
                        tagContainer.appendChild(tagEl);
                    });
                }
                
                function addTag() {
                    const tagValue = tagInput.value.trim();
                    if (tagValue && !state.moodTags.includes(tagValue)) {
                        state.moodTags.push(tagValue);
                        tagInput.value = '';
                        renderTags();
                    }
                }

                addBtn.addEventListener('click', addTag);
                tagInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTag();
                    }
                });
                renderTags();
            }

            function handleImageChange(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    document.getElementById('analysis-error').textContent = '';
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        state.imageBase64 = reader.result;
                        document.getElementById('image-preview').src = state.imageBase64;
                        document.getElementById('image-preview').classList.remove('hidden');
                        document.getElementById('image-placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    state.imageBase64 = '';
                    document.getElementById('image-preview').classList.add('hidden');
                    document.getElementById('image-placeholder').classList.remove('hidden');
                    document.getElementById('analysis-error').textContent = 'Silakan pilih file gambar yang valid.';
                }
                 document.getElementById('image-prompt-container').classList.add('hidden');
            }
            
            function bindDynamicListeners() {
                document.getElementById('image-input').addEventListener('change', handleImageChange);
                document.getElementById('generate-from-image-btn').addEventListener('click', generatePromptFromImage);
            }

            function renderAllUI() {
                dom.manualSectionsContainer.innerHTML = '';
                dom.imageAnalysisContainer.innerHTML = `
                    <div class="mb-10 p-6 bg-blue-50 border-2 border-dashed border-blue-200 rounded-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b-2 border-blue-300 pb-2">Otomatis dari Gambar</h2>
                        <p class="text-gray-600 mb-4">Unggah foto untuk mengisi semua pengaturan secara otomatis.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Pilih File Gambar:</label>
                                <input type="file" id="image-input" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200" />
                                <p id="analysis-error" class="text-red-500 text-xs mt-2"></p>
                                <button id="generate-from-image-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center">
                                    <i class="fas fa-image mr-2"></i> Analisis & Isi Formulir
                                </button>
                            </div>
                            <div class="flex justify-center items-center">
                                <img id="image-preview" src="${state.imageBase64}" alt="Preview" class="max-h-48 rounded-lg shadow-md border ${state.imageBase64 ? '' : 'hidden'}"/>
                                <div id="image-placeholder" class="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 ${state.imageBase64 ? 'hidden' : ''}">Pratinjau Gambar</div>
                            </div>
                        </div>
                        <div id="image-prompt-container" class="hidden mt-8 p-6 bg-indigo-50 border border-indigo-200 rounded-lg shadow-inner">
                            <h2 class="text-xl font-bold text-indigo-800 mb-4 border-b-2 border-indigo-300 pb-2">Prompt yang Dihasilkan dari Gambar:</h2>
                            <pre id="image-prompt-output" class="whitespace-pre-wrap font-mono text-sm text-gray-800 bg-white p-4 rounded-md border border-gray-300 overflow-auto max-h-96"></pre>
                        </div>
                    </div>`;

                const charContent = createCollapsibleSection('character', 'Detail Karakter & Adegan', 'fa-user-pen', dom.manualSectionsContainer, true);
                const charGrid = document.createElement('div');
                charGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4';
                charContent.appendChild(charGrid);
                createTextInput('subjek', 'Subjek', charGrid);
                createTextInput('nama', 'Nama', charGrid);
                createTextInput('usia', 'Usia', charGrid);
                createSelectInput('bentukTubuh', 'Bentuk tubuh', ['Atletis', 'Kurva', 'Ramping', 'Berotot', 'Normal'], charGrid, { hasManual: true, manualId: 'bentukTubuhManual' });
                createSelectInput('detailWajahRambutHidung', 'Detail konsisten wajah, rambut, hidung', ['Wajah oval, rambut panjang bergelombang, hidung mancung', 'Wajah persegi, rambut pendek lurus, hidung kecil'], charGrid, { hasManual: true, manualId: 'detailWajahRambutHidungManual' });
                createSelectInput('pakaian', 'Pakaian', ['Kasual (kaos, jeans)', 'Formal (jas, gaun malam)', 'Sporty (pakaian olahraga)', 'Tradisional (kebaya, batik)', 'Fantasi (kostum pahlawan, gaun peri)'], charGrid, { hasManual: true, manualId: 'pakaianManual' });
                createSelectInput('warnaPakaian', 'Warna pakaian', ['Merah', 'Biru', 'Hijau', 'Hitam', 'Putih'], charGrid, { hasManual: true, manualId: 'warnaPakaianManual' });
                createSelectInput('aksesoris', 'Aksesoris', ['Kacamata', 'Topi', 'Perhiasan (kalung, anting, gelang)', 'Tas', 'Syal'], charGrid, { hasManual: true, manualId: 'aksesorisManual' });
                createSelectInput('rasEtnis', 'Ras/Etnis', ['Asia', 'Kaukasia', 'Afrika', 'Latin', 'Timur Tengah'], charGrid, { hasManual: true, manualId: 'rasEtnisManual' });
                createTextInput('ekspresi', 'Ekspresi', charGrid);
                createTextInput('tempat', 'Tempat', charGrid);
                
                const sceneContent = createCollapsibleSection('scene', 'Struktur Adegan & Dialog', 'fa-film', dom.manualSectionsContainer);
                createTextarea('scene1Input', 'Scene 1', sceneContent, { className: 'md:col-span-1' });
                createTextarea('scene2Input', 'Scene 2', sceneContent, { className: 'md:col-span-1' });
                createTextInput('kalimatDiucapkan', 'Kalimat yang diucapkan', sceneContent, {className: 'md:col-span-2'});
                createTextInput('suaraMusik', 'Musik/Suara', sceneContent, {className: 'md:col-span-2'});

                const basicContent = createCollapsibleSection('basic', 'Basic Settings', 'fa-sliders-h', dom.manualSectionsContainer);
                const basicGrid = document.createElement('div');
                basicGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4';
                basicContent.appendChild(basicGrid);
                createSelectInput('visualStyle', 'Visual Style', [{value: 'cinematic', label:'Cinematic'}, {value: 'anime', label:'Anime'}, {value: 'realistic', label:'Photorealistic'}, {value: 'watercolor', label:'Watercolor'}, {value: 'pixel-art', label:'Pixel Art'}, {value: 'cyberpunk', label:'Cyberpunk'}, {value: 'retro', label:'Retro'}, {value: 'futuristic', label:'Futuristic'}], basicGrid);
                createTextInput('duration', 'Duration (sec)', basicGrid, { type: 'number', min: 1, max: 120 });
                createSelectInput('aspectRatio', 'Aspect Ratio', [{value: '16:9', label:'16:9 (Widescreen)'}, {value: '9:16', label:'9:16 (Vertical)'}, {value: '1:1', label:'1:1 (Square)'}, {value: '4:3', label:'4:3 (Classic)'}, {value: '21:9', label:'21:9 (Cinematic)'}], basicGrid);
                createSelectInput('frameRate', 'Frame Rate', [{value: '24', label:'24 fps (Cinematic)'}, {value: '30', label:'30 fps (Standard)'}, {value: '60', label:'60 fps (Smooth)'}, {value: '120', label:'120 fps (Slow Motion)'}], basicGrid);

                const cineContent = createCollapsibleSection('cinematography', 'Cinematography', 'fa-camera', dom.manualSectionsContainer);
                const cineGrid = document.createElement('div');
                cineGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4';
                cineContent.appendChild(cineGrid);
                createSelectInput('cameraMovement', 'Camera Movement', [{value: 'static', label: 'Static'}, {value: 'slow-pan', label: 'Slow Pan'}, {value: 'dolly', label: 'Dolly'}, {value: 'tracking', label: 'Tracking'}, {value: 'crane', label: 'Crane'}, {value: 'steadycam', label: 'Steadycam'}, {value: 'handheld', label: 'Handheld'}, {value: 'drone', label: 'Drone'}], cineGrid);
                createSelectInput('cameraAngle', 'Camera Angle', [{value: 'eye-level', label: 'Eye Level'}, {value: 'low-angle', label: 'Low Angle'}, {value: 'high-angle', label: 'High Angle'}, {value: 'dutch-angle', label: 'Dutch Angle'}, {value: 'overhead', label: 'Overhead'}, {value: 'point-of-view', label: 'Point of View'}], cineGrid);
                createSelectInput('lensType', 'Lens Type', [{value: 'standard', label: 'Standard (50mm)'}, {value: 'wide-angle', label: 'Wide Angle (24mm)'}, {value: 'telephoto', label: 'Telephoto (85mm+)'}, {value: 'fisheye', label: 'Fisheye'}, {value: 'anamorphic', label: 'Anamorphic'}, {value: 'macro', label: 'Macro'}], cineGrid);
                createSelectInput('depthOfField', 'Depth of Field', ['shallow', 'medium', 'deep'], cineGrid);

                const moodContent = createCollapsibleSection('mood', 'Mood & Atmosphere', 'fa-cloud-sun', dom.manualSectionsContainer);
                const moodGrid = document.createElement('div');
                moodGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4';
                moodContent.appendChild(moodGrid);
                createSelectInput('waktu', 'Time of Day', [{value: 'golden-hour', label:'Golden Hour'}, {value: 'blue-hour', label:'Blue Hour'}, {value: 'midday', label:'Midday'}, {value: 'night', label:'Night'}, {value: 'sunrise', label:'Sunrise'}, {value: 'sunset', label:'Sunset'}, {value: 'twilight', label:'Twilight'}], moodGrid);
                createSelectInput('weather', 'Weather', ['clear', 'cloudy', 'rainy', 'foggy', 'snowy', 'stormy'], moodGrid);
                createTagInput('mood-tags', 'Mood Tags', moodContent);
                createTextInput('suasanaVideoManual', 'Mood Description', moodContent, { className: 'md:col-span-2'});


                const effectsContent = createCollapsibleSection('effects', 'Visual Effects', 'fa-magic', dom.manualSectionsContainer);
                const effectsGrid = document.createElement('div');
                effectsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4';
                effectsContent.appendChild(effectsGrid);
                createRangeSlider('filmGrain', 'Film Grain', effectsGrid);
                createRangeSlider('chromaticAberration', 'Chromatic Aberration', effectsGrid);
                createSelectInput('colorGrading', 'Color Grading', ['neutral', 'teal-orange', 'cool', 'warm', 'high-contrast', 'monochrome', 'vintage'], effectsGrid);
                createSelectInput('dynamicRange', 'Dynamic Range', [{value:'standard', label: 'Standard'}, {value:'high', label:'High (HDR)'}, {value:'log', label:'Log (Flat Profile)'}], effectsGrid);
                const effectsCheckboxesContainer = document.createElement('div');
                effectsCheckboxesContainer.className = 'md:col-span-2 mt-4';
                effectsContent.appendChild(effectsCheckboxesContainer);
                createCheckboxGroup('Basic Effects', [ {id: 'motion-blur', label: 'Motion Blur'}, {id: 'lens-flare', label: 'Lens Flare'}, {id: 'light-leaks', label: 'Light Leaks'}, {id: 'film-scratches', label: 'Film Scratches'}, {id: 'vignette', label: 'Vignette'} ], effectsCheckboxesContainer);
                
                const advancedContent = createCollapsibleSection('advanced', 'Advanced Settings', 'fa-cogs', dom.manualSectionsContainer);
                const advancedGrid = document.createElement('div');
                advancedGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4';
                advancedContent.appendChild(advancedGrid);
                createSelectInput('videoEngine', 'Video Engine', [{value: 'stable-video-diffusion', label: 'Stable Video Diffusion'}, {value: 'animatediff', label: 'AnimateDiff'}, {value: 'sora', label: 'Sora (AI)'}, {value: 'pika', label: 'Pika Labs'}, {value: 'runway', label: 'Runway ML'}, {value: 'veo3', label: 'Veo3 (Google)'}, {value: 'veo2', label: 'Veo2 (Google)'}, {value: 'tensor-video', label: 'Tensor Video'}], advancedGrid);
                createTextInput('seed', 'Seed Value', advancedGrid, {type: 'number', min: -1, placeholder: '-1 for random'});
                createRangeSlider('consistency', 'Frame Consistency', advancedGrid);
                createRangeSlider('motionIntensity', 'Motion Intensity', advancedGrid);

                bindDynamicListeners();
            }

            function updateLoadingState(button, isLoading, loadingText, defaultTextIcon) {
                const iconClass = defaultTextIcon.split(' ')[0];
                const text = defaultTextIcon.substring(iconClass.length + 1);
                button.disabled = isLoading;
                if (isLoading) {
                    button.innerHTML = `<span class="loader mr-3"></span>${loadingText}`;
                } else {
                    button.innerHTML = `<i class="fas ${iconClass} mr-2"></i> ${text}`;
                }
            }
            
            async function generatePromptFromImage() {
                // --- IKLAN: LOGIC UNTUK KLIK TOMBOL "ANALISIS" ---
                 openRandomAd(adLinks);
                // --- AKHIR IKLAN ---
                
                if (!state.imageBase64) {
                    showError('Silakan unggah gambar terlebih dahulu.');
                    return;
                }
                const btn = document.getElementById('generate-from-image-btn');
                updateLoadingState(btn, true, 'Menganalisis...', 'fa-image Analisis & Isi Formulir');
                hideError();
                document.getElementById('image-prompt-container').classList.add('hidden');

                try {
                    const base64Data = state.imageBase64.split(',')[1];
                    const mimeType = state.imageBase64.split(';')[0].split(':')[1];
                    const analysisPrompt = `Analyze this image in detail as a professional cinematographer. Extract or infer the following attributes and return them as a valid JSON object.
- subjek: A detailed description of the main subject.
- rasEtnis: The race or ethnicity of the person (e.g., 'Asia', 'Kaukasia').
- ekspresi: The facial expression of the subject.
- pakaian: Description of the clothing.
- aksesoris: Description of accessories.
- tempat: The setting or location.
- suasanaVideoManual: A short phrase describing the overall mood (e.g., 'Misterius dan menegangkan', 'Ceria dan penuh semangat').
- visualStyle: Suggest a visual style from this list: 'cinematic', 'anime', 'realistic', 'watercolor', 'pixel-art', 'cyberpunk', 'retro', 'futuristic'.
- cameraAngle: Suggest a camera angle from: 'eye-level', 'low-angle', 'high-angle', 'dutch-angle', 'overhead', 'point-of-view'.
- lensType: Suggest a lens type from: 'standard', 'wide-angle', 'telephoto', 'fisheye', 'anamorphic', 'macro'.
- depthOfField: Suggest a depth of field from: 'shallow', 'medium', 'deep'.
- waktu: Infer the time of day from: 'golden-hour', 'blue-hour', 'midday', 'night', 'sunrise', 'sunset', 'twilight'.
- weather: Infer the weather from: 'clear', 'cloudy', 'rainy', 'foggy', 'snowy', 'stormy'.
- colorGrading: Suggest a color grading style from: 'neutral', 'teal-orange', 'cool', 'warm', 'high-contrast', 'monochrome', 'vintage'.
- moodTags: Provide an array of 3-5 relevant mood tags as strings (e.g., ["dreamy", "nostalgic", "serene"]).
- scene1Input: A concise description for a potential first scene based on the image.
- scene2Input: A concise description for a potential second scene that follows the first.`;

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: analysisPrompt }, { inlineData: { mimeType, data: base64Data } }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    const decodedApiKey = atob(obfuscatedApiKey);
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${decodedApiKey}`;

                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();

                    if (!response.ok) throw new Error(`API Error: ${response.status} - ${result.error?.message || JSON.stringify(result)}`);

                    if (result.candidates && result.candidates.length > 0) {
                        const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                        // Update state with all inferred values
                        Object.assign(state, {
                            subjek: jsonResponse.subjek || state.subjek,
                            rasEtnis: 'Isi manual',
                            rasEtnisManual: jsonResponse.rasEtnis || state.rasEtnisManual,
                            ekspresi: jsonResponse.ekspresi || state.ekspresi,
                            pakaian: 'Isi manual',
                            pakaianManual: jsonResponse.pakaian || state.pakaianManual,
                            aksesoris: 'Isi manual',
                            aksesorisManual: jsonResponse.aksesoris || state.aksesorisManual,
                            tempat: jsonResponse.tempat || state.tempat,
                            suasanaVideoManual: jsonResponse.suasanaVideoManual || state.suasanaVideoManual,
                            visualStyle: jsonResponse.visualStyle || state.visualStyle,
                            cameraAngle: jsonResponse.cameraAngle || state.cameraAngle,
                            lensType: jsonResponse.lensType || state.lensType,
                            depthOfField: jsonResponse.depthOfField || state.depthOfField,
                            waktu: jsonResponse.waktu || state.waktu,
                            weather: jsonResponse.weather || state.weather,
                            colorGrading: jsonResponse.colorGrading || state.colorGrading,
                            moodTags: jsonResponse.moodTags || state.moodTags,
                            scene1Input: jsonResponse.scene1Input || state.scene1Input,
                            scene2Input: jsonResponse.scene2Input || state.scene2Input,
                        });
                        
                        // Show generated prompt below the image
                        const displayPrompt = `Subjek: ${jsonResponse.subjek || 'N/A'}\nLokasi: ${jsonResponse.tempat || 'N/A'}\nGaya: ${jsonResponse.visualStyle || 'N/A'}\nMood: ${jsonResponse.suasanaVideoManual || 'N/A'}`;
                        document.getElementById('image-prompt-output').textContent = displayPrompt;
                        document.getElementById('image-prompt-container').classList.remove('hidden');

                        // Re-render the entire UI to reflect the new state in the forms
                        renderAllUI();
                        Swal.fire({
                           title: 'Berhasil!',
                           text: 'Formulir telah berhasil diisi berdasarkan analisis gambar.',
                           icon: 'success',
                           confirmButtonText: 'Ok'
                        });
                    } else {
                        showError('Gagal menganalisis gambar. Respons tidak valid atau konten diblokir.');
                        console.error("Invalid Response Body:", result);
                    }
                } catch (err) {
                    showError('Error saat menganalisis gambar: ' + err.message);
                    console.error("Fetch Error:", err);
                } finally {
                    updateLoadingState(btn, false, 'Menganalisis...', 'fa-image Analisis & Isi Formulir');
                }
            }

            function generateFinalPrompt() {
                // --- IKLAN: LOGIC UNTUK KLIK TOMBOL "GABUNGKAN" ---
                openRandomAd(adLinks);
                // --- AKHIR IKLAN ---

                updateLoadingState(dom.generateFinalPromptBtn, true, 'Sedang membuat...', 'fa-magic Gabungkan & Buat Prompt Final');
                hideError();
                hideFinalPrompt();

                const getFinalValue = (baseKey, manualKey) => state[baseKey] === 'Isi manual' ? state[manualKey] : state[baseKey];
                
                let activeEffects = Object.entries(state.effects)
                    .filter(([key, value]) => value === true)
                    .map(([key]) => key.replace(/-/g, ' '));
                
                let promptText = `--- VISUAL & TECHNICAL SPECS ---\n`;
                promptText += `Engine: ${state.videoEngine}, Visual Style: ${state.visualStyle}, Duration: ${state.duration}s, Aspect Ratio: ${state.aspectRatio}, Frame Rate: ${state.frameRate}fps, Seed: ${state.seed}.\n`;
                promptText += `Lens: ${state.lensType}, Depth of Field: ${state.depthOfField}, Camera Angle: ${state.cameraAngle}, Camera Movement: ${state.cameraMovement}.\n`;

                promptText += `\n--- MOOD & ATMOSPHERE ---\n`;
                promptText += `Time of Day: ${state.waktu}, Weather: ${state.weather}, Mood: ${state.suasanaVideoManual}${state.moodTags.length > 0 ? ', ' + state.moodTags.join(', ') : ''}.\n`;

                promptText += `\n--- VISUAL EFFECTS ---\n`;
                promptText += `Color Grading: ${state.colorGrading}, Dynamic Range: ${state.dynamicRange}, Film Grain: ${state.filmGrain}%, Chromatic Aberration: ${state.chromaticAberration}%, Motion Intensity: ${state.motionIntensity}%, Consistency: ${state.consistency}%.\n`;
                if(activeEffects.length > 0) promptText += `Additional Effects: ${activeEffects.join(', ')}.\n`;
                
                promptText += `\n--- CHARACTER & NARRATIVE ---\n`;
                promptText += `Subject: ${state.subjek}.\n`;
                if(state.nama) promptText += `Name: ${state.nama}.\n`;
                if(state.usia) promptText += `Age: ${state.usia}.\n`;
                promptText += `Appearance: ${getFinalValue('detailWajahRambutHidung', 'detailWajahRambutHidungManual')}, ${getFinalValue('bentukTubuh', 'bentukTubuhManual')} body shape, ${getFinalValue('rasEtnis', 'rasEtnisManual')}.\n`;
                promptText += `Clothing: ${getFinalValue('pakaian', 'pakaianManual')} (${getFinalValue('warnaPakaian', 'warnaPakaianManual')}) with ${getFinalValue('aksesoris', 'aksesorisManual')}.\n`;
                if(state.ekspresi) promptText += `Expression: ${state.ekspresi}.\n`;

                promptText += `\n--- SCENE DESCRIPTION ---\n`;
                if (state.sceneManual) {
                    promptText += `Scene: ${state.sceneManual}\n`;
                } else {
                    promptText += `Scene 1: ${state.scene1Input}\n`;
                    promptText += `Scene 2: ${state.scene2Input}\n`;
                }
                
                if(state.kalimatDiucapkan) promptText += `\n--- DIALOGUE ---\n"${state.kalimatDiucapkan}"\n`;
                if(state.suaraMusik) promptText += `\n--- AUDIO ---\nMusic/Sound: ${state.suaraMusik}.\n`;
                if(state.detailTambahan) promptText += `\n--- ADDITIONAL DETAILS ---\n${state.detailTambahan}\n`;
                
                showFinalPrompt(promptText.trim());
                updateLoadingState(dom.generateFinalPromptBtn, false, 'Gabungkan & Buat Prompt Final', 'fa-magic Gabungkan & Buat Prompt Final');
            }

            function copyToClipboard(textToCopy, type) {
                // --- IKLAN: LOGIC UNTUK KLIK TOMBOL "SALIN" ---
              //  openRandomAd(adLinks);
                // --- AKHIR IKLAN ---

                navigator.clipboard.writeText(textToCopy).then(() => {
                    Swal.fire({
                      toast: true,
                      position: 'top-end',
                      icon: 'success',
                      title: `${type} berhasil disalin!`,
                      showConfirmButton: false,
                      timer: 2000,
                      timerProgressBar: true,
                    });
                }).catch(err => {
                    Swal.fire({
                      icon: 'error',
                      title: 'Oops...',
                      text: `Gagal menyalin ${type}.`,
                    });
                });
            }
            function showError(message) {
                 Swal.fire({
                      icon: 'error',
                      title: 'Terjadi Kesalahan',
                      text: message,
                 });
            }
            function hideError() { /* No longer needed */ }
            function hideFinalPrompt() { dom.finalPromptContainer.classList.add('hidden'); }
            function showFinalPrompt(text) {
                dom.finalPromptOutput.textContent = text;
                dom.finalPromptContainer.classList.remove('hidden');
            }


            // --- INITIALIZATION ---
            renderAllUI();
            dom.generateFinalPromptBtn.addEventListener('click', generateFinalPrompt);
            dom.copyFinalPromptBtn.addEventListener('click', () => copyToClipboard(dom.finalPromptOutput.textContent, 'Prompt Final'));
        });
